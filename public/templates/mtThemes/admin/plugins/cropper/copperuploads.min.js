$(function() {

    $(document).on('change', '.choose-file-media', function() {
        if($(this).is('checked')) {
            $('.useFile').prop('disabled', true);
        }
    });

    $('.file-list-items').on('click', function() {
        $el = $(this).find('input[type="radio"]');
        if($el.is(":checked")) {
            $el.prop('checked', false);
        } else {
            $el.prop('checked', true);
        }
        
    });

    //Mở popup file manager
    $('.btnAddMedia').on('click', function() {
        $('#uploadBox').removeClass('hide');
        var baseurl = parse_url([app_page, 'uploads', 'loadfolder', 0]); //Mặc định load những thư mục và file có folder_id == 0
        loadData({themes: app_themes}, baseurl, '.media', 'alert', 'media');
    });

    //Load file when click folder
    $(document).on('click', '.loadfile', function() {
        var folder_id   = $(this).attr('data-id');
        $('#hiddenFolderID').val(folder_id);
        var baseurl     = parse_url([app_page, 'uploads', 'loadfolder', folder_id]); //Mặc định load những thư mục và file có folder_id == 0
        loadData({themes: app_themes}, baseurl, '.media', 'alert', 'mediafile');
    });

    $('.media-close').on('click', function() {
        $('#uploadBox').addClass('hide');
    });

    $('.addFile').on('click', function() {
        $(this).addClass('hide');
        $('.dropzone-upload-media').removeClass('hide');
        $('.closeDropZone').removeClass('hide');
    });

    $('.closeDropZone').on('click', function() {
        $(this).addClass('hide');
        $('.dropzone-upload-media').addClass('hide');
        $('.addFile').removeClass('hide');
    });

    $('.addFolder').on('click', function() {
        $('.addfolder-form').addClass('open');
        $('.media-addfolder-form').removeClass('hide');
    });

    $('.closeaddfolder').on('click', function() {
        $('.addfolder-form').removeClass('open');
        $('.media-addfolder-form').addClass('hide');
    });

    //Thêm folder
    $('.btnaddfolderaction').on('click', function() {
        var folder_id   = $('#hiddenFolderID').val();
        var folder_name = $('#mediaFolderName').val();
        addFolder('uploads/addfolder', folder_id, folder_name, '.errors');
    });

});


// transform cropper dataURI output to a Blob which Dropzone accepts
function dataURItoBlob(dataURI) {
    var byteString = atob(dataURI.split(',')[1]);
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], { type: 'image/jpeg' });
}

// modal window template
var modalTemplate = '<div id="modalCropImage" class="modal in" data-easein="bounceIn"  data-target="#modalCropImage" tabindex="-1" role="dialog">'
                        +'<div class="modal-dialog modal-lg" role="document">'
                            +'<div class="modal-content">'
                                +'<div class="modal-header">' 
                                    +'<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                                    +'<h4 class="modal-title">Crop</h4>'
                                +'</div>'
                                +'<div class="modal-body">'
                                    +'<div class="image-container">'
                                        +'<img id="imgCrop" src="http://minhtrucit.com/public/uploads/avatar/1111-27478.jpg" data-name="1111-27478.jpg">'
                                    +'</div>'
                                +'</div>'
                                +'<div class="modal-footer">'
                                    +'<button type="button" class="btn btn-warning rotate-left"><span class="fa fa-rotate-left"></span></button>'
                                    +'<button type="button" class="btn btn-warning rotate-right"><span class="fa fa-rotate-right"></span></button>'
                                    +'<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>'
                                    +'<button type="button" class="btn btn-primary crop-upload">Hoàn thành</button>'
                                +'</div>'
                            +'</div>'
                        +'</div>'
                    +'</div>';

// initialize dropzone
Dropzone.autoDiscover = false;
var myDropzone = new Dropzone(
    "#UploadImages",
    {
        autoProcessQueue: false,
        // ..your other parameters..
    }
);

// listen to thumbnail event
myDropzone.on('thumbnail', function (file) {
    // ignore files which were already cropped and re-rendered
    // to prevent infinite loop
    if (file.cropped) {
        return;
    }
    if (file.width < 800) {
        // validate width to prevent too small files to be uploaded
        // .. add some error message here
        return;
    }
    // cache filename to re-assign it to cropped file
    var cachedFilename = file.name;
    // remove not cropped file from dropzone (we will replace it later)
    myDropzone.removeFile(file);

    // dynamically create modals to allow multiple files processing
    var $cropperModal = $(modalTemplate);
    // 'Crop and Upload' button in a modal
    var $uploadCrop = $cropperModal.find('.crop-upload');

    var $img = $('<img />');
    // initialize FileReader which reads uploaded file
    var reader = new FileReader();
    reader.onloadend = function () {
        // add uploaded and read image to modal
        $cropperModal.find('.image-container').html($img);
        $img.attr('src', reader.result);

        // initialize cropper for uploaded image
        $('#imgCrop').cropper({
            aspectRatio: 16 / 9,
            autoCropArea: 1,
            movable: false,
            cropBoxResizable: true,
            minContainerWidth: 850
        });
        // var cropper = new Cropper(document.getElementById('imgCrop'), {
        //     dragMode: 'move',
        //     aspectRatio: 16 / 9,
        //     autoCropArea: 1, //Khung cắt không full hình
        //     restore: false,
        //     guides: false, //Chia làm 9 ô trong khung cắt (Grid)
        //     center: true,  //Đặt khung cắt nằm giữa hình
        //     highlight: true, //Làm tối vùng ngoài khung cắt
        //     cropBoxMovable: false, //Di chuyển khung cắt
        //     cropBoxResizable: false, //Kéo cộng khung cắt
        //     toggleDragModeOnDblclick: false, //Thay đổi khung cắt khi click đúp chuột
        // });
    };
    // read uploaded file (triggers code above)
    reader.readAsDataURL(file);

    $cropperModal.modal('show');

    // $cropperModal.modal('show').on("shown.bs.modal", function () {
    //     // $images = $('#imgCrop');
        
    // });

    // listener for 'Crop and Upload' button in modal
    $uploadCrop.on('click', function() {
        // get cropped image data
        var blob = $img.cropper('getCroppedCanvas').toDataURL();
        // transform it to Blob object
        var newFile = dataURItoBlob(blob);
        // set 'cropped to true' (so that we don't get to that listener again)
        newFile.cropped = true;
        // assign original filename
        newFile.name = cachedFilename;

        // add cropped file to dropzone
        myDropzone.addFile(newFile);
        // upload cropped file with dropzone
        myDropzone.processQueue();
        // $cropperModal.modal('hide');
    });
});